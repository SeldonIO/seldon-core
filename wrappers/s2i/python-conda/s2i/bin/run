#!/bin/bash -e
#
# S2I run script for the 'seldon-core-s2i-python' image.
# The run script executes the server that runs your application.
#
# For more information see the documentation:
#	https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md
#

# Check environment vars
if [[ -z "$MODEL_NAME" || -z "$API_TYPE" || -z "$SERVICE_TYPE" || -z "$PERSISTENCE" ]]; then
  echo "Failed to find required env vars MODEL_NAME, API_TYPE, SERVICE_TYPE, PERSISTENCE"
  exit 1
else
  cd /microservice

  if [[ -x before-run ]]; then
    echo "Executing before-run script"
    ./before-run
  fi

  # TODO: Support other env names
  if [[ -f conda.yaml ]]; then
    CONDA_ENV_NAME=${CONDA_ENV_NAME:-microservice}
    echo "Activating Conda environment '$CONDA_ENV_NAME'"
    # We need to initialise Conda so that it can run on /bin/sh
    source /etc/profile.d/conda.sh
    conda activate $CONDA_ENV_NAME
  fi

  echo "Starting microservice"
  exec seldon-core-microservice $MODEL_NAME $API_TYPE --service-type $SERVICE_TYPE --persistence $PERSISTENCE
fi
