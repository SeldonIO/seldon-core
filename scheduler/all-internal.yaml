version: "3.9"

volumes:
  models-mlserver:
  models-triton:

services:

  agent-mlserver:
    command:
      - "/bin/agent"
      - "--log-level"
      - "debug"
      - "--config-path"
      - "/mnt/config"
      - "--rclone-host"
      - "rclone-mlserver"
      - "--inference-host"
      - "mlserver"
      - "--agent-host"
      - "agent-mlserver"
      - "--server-name"
      - "mlserver"
      - "--tracing-config-path"
      - "/mnt/config/tracing-internal.json"
    environment:
      - SELDON_OVERCOMMIT_PERCENTAGE=${AGENT_OVERCOMMIT_PERCENTAGE}
      - SELDON_REVERSE_PROXY_HTTP_PORT=${SELDON_MLSERVER_REVERSE_PROXY_HTTP_PORT}
      - SELDON_REVERSE_PROXY_GRPC_PORT=${SELDON_MLSERVER_REVERSE_PROXY_GRPC_PORT}
      - SELDON_SERVER_HTTP_PORT=${SERVER_MLSERVER_HTTP_PORT}
      - SELDON_SERVER_GRPC_PORT=${SERVER_MLSERVER_GRPC_PORT}
      - SELDON_DEBUG_GRPC_PORT=${AGENT_MLSERVER_DEBUG_PORT}
      - SELDON_SCHEDULER_HOST=scheduler
      - SELDON_SCHEDULER_PORT=${SCHEDULER_AGENT_PORT}
      - MEMORY_REQUEST=${AGENT_MEMORY_REQUEST}
      - SELDON_ENVOY_HOST=envoy            
      - SELDON_ENVOY_PORT=${ENVOY_DATA_PORT}
      - SELDON_SERVER_TYPE=mlserver
      - SELDON_SERVER_CAPABILITIES=mlserver,alibi-detect,alibi-explain,lightgbm,mlflow,python,sklearn,spark-mlib,xgboost
    ports:
      - "${AGENT_MLSERVER_HTTP_PORT}:${AGENT_MLSERVER_HTTP_PORT}"
      - "${AGENT_MLSERVER_GRPC_PORT}:${AGENT_MLSERVER_GRPC_PORT}"
      - "${SELDON_MLSERVER_REVERSE_PROXY_HTTP_PORT}:${SELDON_MLSERVER_REVERSE_PROXY_HTTP_PORT}"
      - "${SELDON_MLSERVER_REVERSE_PROXY_GRPC_PORT}:${SELDON_MLSERVER_REVERSE_PROXY_GRPC_PORT}"
    volumes:
      - type: bind
        source: ./config
        target: /mnt/config
      - type: volume
        source: models-mlserver
        target: /mnt/agent

  agent-triton:
    command:
      - "/bin/agent"
      - "--log-level"
      - "debug"
      - "--config-path"
      - "/mnt/config"
      - "--rclone-host"
      - "rclone-triton"
      - "--rclone-port"
      - ${RCLONE_TRITON_HTTP_PORT}
      - "--inference-host"
      - "triton"
      - "--agent-host"
      - "agent-triton"
      - "--server-name"
      - "triton"
      - "--tracing-config-path"
      - "/mnt/config/tracing-internal.json"
    ports:
      - "${AGENT_TRITON_HTTP_PORT}:${AGENT_TRITON_HTTP_PORT}"
      - "${AGENT_TRITON_GRPC_PORT}:${AGENT_TRITON_GRPC_PORT}"
      - "${SELDON_TRITON_REVERSE_PROXY_HTTP_PORT}:${SELDON_TRITON_REVERSE_PROXY_HTTP_PORT}"
      - "${SELDON_TRITON_REVERSE_PROXY_GRPC_PORT}:${SELDON_TRITON_REVERSE_PROXY_GRPC_PORT}"
    volumes:
      - type: bind
        source: ./config
        target: /mnt/config
      - type: volume
        source: models-triton
        target: /mnt/agent

  dataflow:
    environment:
      - SELDON_UPSTREAM_PORT=${SCHEDULER_DATAFLOW_PORT}
      - SELDON_KAFKA_BOOTSTRAP_SERVERS=kafka:${KAFKA_BROKER_INTERNAL_PORT}
      - SELDON_CORES_COUNT=4
      - SELDON_UPSTREAM_HOST=scheduler
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_JAVAAGENT_ENABLED=${OTEL_JAVAAGENT_ENABLED}

  envoy:
    ports:
      - "${ENVOY_DATA_PORT}:${ENVOY_DATA_PORT}"
      - "${ENVOY_CONTROL_PORT}:${ENVOY_CONTROL_PORT}"
    command:
      - "/usr/local/bin/envoy"
      - "-c"
      - "/etc/envoy-compose.yaml"

  hodometer:
    environment:
      - SCHEDULER_HOST=scheduler

  kafka:
    environment:
    - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CLIENT:PLAINTEXT,EXTERNAL:PLAINTEXT
    - KAFKA_CFG_LISTENERS=CLIENT://:9093,EXTERNAL://:9092
    - KAFKA_CFG_ADVERTISED_LISTENERS=CLIENT://kafka:9093,EXTERNAL://localhost:9092
    - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=CLIENT
    - KAFKA_BROKER_ID=1
    - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
    - ALLOW_PLAINTEXT_LISTENER=yes
    - KAFKA_CFG_MESSAGE_MAX_BYTES=1000000000
    ports:
      - "9092:9092"

  mlserver:
    ports:
      - "${SERVER_MLSERVER_HTTP_PORT}:${SERVER_MLSERVER_HTTP_PORT}"
      - "${SERVER_MLSERVER_GRPC_PORT}:${SERVER_MLSERVER_GRPC_PORT}"
    volumes:
      - type: volume
        source: models-mlserver
        target: /mnt/agent

  modelgateway:
    command:
      - "/bin/modelgateway"
      - "--log-level"
      - "debug"
      - "--kafka-config-path"
      - "/mnt/config/kafka-internal.json"
      - "--scheduler-host"
      - "scheduler"
      - "--scheduler-port"
      - ${SCHEDULER_SERVER_PORT}
      - "--envoy-host"
      - "envoy"
      - "--envoy-port"
      - ${ENVOY_DATA_PORT}
      - "--tracing-config-path"
      - "/mnt/config/tracing-internal.json"
    volumes:
      - type: bind
        source: ./config
        target: /mnt/config

  pipelinegateway:
    command:
      - "/bin/pipelinegateway"
      - "--log-level"
      - "debug"
      - "--kafka-config-path"
      - "/mnt/config/kafka-internal.json"
      - "--http-port"
      - ${PIPELINEGATEWAY_HTTP_PORT}
      - "--grpc-port"
      - ${PIPELINEGATEWAY_GRPC_PORT}
      - "--metrics-port"
      - ${PIPELINEGATEWAY_METRICS_PORT}
      - "--tracing-config-path"
      - "/mnt/config/tracing-internal.json"
    volumes:
      - type: bind
        source: ./config
        target: /mnt/config
    ports:
      - "${PIPELINEGATEWAY_HTTP_PORT}:${PIPELINEGATEWAY_HTTP_PORT}"
      - "${PIPELINEGATEWAY_GRPC_PORT}:${PIPELINEGATEWAY_GRPC_PORT}"

  prometheus:
    command:
      - --config.file=/etc/prometheus/prometheus-internal.yml
    ports:
      - "9090:9090"      
    volumes:
      - type: bind
        source: ./config
        target: /etc/prometheus

  rclone-mlserver:
    ports:
      - "${RCLONE_MLSERVER_HTTP_PORT}:${RCLONE_MLSERVER_HTTP_PORT}"
    volumes:
      - type: volume
        source: models-mlserver
        target: /mnt/agent

  rclone-triton:
    ports:
      - "${RCLONE_TRITON_HTTP_PORT}:${RCLONE_TRITON_HTTP_PORT}"
    volumes:
      - type: volume
        source: models-triton
        target: /mnt/agent

  scheduler:
    command:
      - "/bin/scheduler"
      - "--log-level"
      - "debug"
      - "--pipeline-gateway-host"
      - "pipelinegateway"
      - "--tracing-config-path"
      - "/mnt/config/tracing-internal.json"
      - --db-path
      - ${DB_PATH_COMPOSE}
    volumes:
      - type: bind
        source: ./config
        target: /mnt/config
      - type: bind
        source: ./mnt/db
        target: /mnt/db
    ports:
      - "${SCHEDULER_XDS_PORT}:${SCHEDULER_XDS_PORT}"
      - "${SCHEDULER_SERVER_PORT}:${SCHEDULER_SERVER_PORT}"
      - "${SCHEDULER_AGENT_PORT}:${SCHEDULER_AGENT_PORT}"

  triton:
    ports:
      - "${SERVER_TRITON_HTTP_PORT}:${SERVER_TRITON_HTTP_PORT}"
      - "${SERVER_TRITON_GRPC_PORT}:${SERVER_TRITON_GRPC_PORT}"
    volumes:
      - type: volume
        source: models-triton
        target: /mnt/agent
    depends_on:
      - agent-triton

  zookeeper:
    ports:
      - "2181:2181"
