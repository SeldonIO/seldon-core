version: "3.9"

services:

  agent-mlserver:
    network_mode: "host"
    command:
      - "/bin/agent"
      - "--log-level"
      - "debug"
      - "--config-path"
      - "/mnt/config"
      - "--server-name"
      - "mlserver"
      - "--metrics-port"
      - ${AGENT_MLSERVER_METRICS_PORT}
    environment:
      - SELDON_SCHEDULER_HOST=0.0.0.0
    volumes:
      - type: bind
        source: ./config
        target: /mnt/config
      - type: bind
        source: ./mnt/mlserver
        target: /mnt/agent

  agent-triton:
    network_mode: "host"
    command:
      - "/bin/agent"
      - "--log-level"
      - "debug"
      - "--config-path"
      - "/mnt/config"
      - "--rclone-port"
      - ${RCLONE_TRITON_HTTP_PORT}
      - "--metrics-port"
      - ${AGENT_TRITON_METRICS_PORT}
      - "--server-name"
      - "triton"
    environment:
      - SELDON_SCHEDULER_HOST=0.0.0.0
    volumes:
      - type: bind
        source: ./config
        target: /mnt/config
      - type: bind
        source: ./mnt/triton
        target: /mnt/agent
        
  rclone-mlserver:
    network_mode: "host"
    volumes:
      - type: bind
        source: ${PWD}/mnt/mlserver
        target: /mnt/agent

  rclone-triton:
    network_mode: "host"
    volumes:
      - type: bind
        source: ${PWD}/mnt/triton
        target: /mnt/agent

  mlserver:
    network_mode: "host"
    volumes:
      - type: bind
        source: ${PWD}/mnt/mlserver
        target: /mnt/agent
        
  triton:
    network_mode: "host"
    volumes:
      - type: bind
        source: ${PWD}/mnt/triton
        target: /mnt/agent
        
  scheduler:
    command:
      - "/bin/scheduler"
      - "--log-level"
      - "debug"
      - --pipeline-db-path
      - "${PIPELINE_DB_PATH_COMPOSE}"
    network_mode: "host"

  dataflow:
    network_mode: "host"
    environment:
      - SELDON_UPSTREAM_HOST=localhost      
      - SELDON_UPSTREAM_PORT=${SCHEDULER_DATAFLOW_PORT}
      - SELDON_KAFKA_BOOTSTRAP_SERVERS=0.0.0.0:${KAFKA_BROKER_EXTERNAL_PORT}
      - SELDON_CORES_COUNT=4

  envoy:
    network_mode: "host"
    command:
      - "/usr/local/bin/envoy"
      - "-c"
      - "/etc/envoy-local.yaml"

  modelgateway:
    network_mode: "host"
    volumes:
      - type: bind
        source: ./config
        target: /mnt/config
    command:
      - "/bin/modelgateway"
      - "--log-level"
      - "debug"
      - "--config-path"
      - "/mnt/config/kafka-host.json"
      - "--scheduler-port"
      - ${SCHEDULER_SERVER_PORT}
      - "--envoy-port"
      - ${ENVOY_DATA_PORT}
      
  pipelinegateway:
    network_mode: "host"    
    volumes:
      - type: bind
        source: ./config
        target: /mnt/config
    command:
      - "/bin/pipelinegateway"
      - "--log-level"
      - "debug"
      - "--config-path"
      - "/mnt/config/kafka-host.json"
      - "--http-port"
      - ${PIPELINEGATEWAY_HTTP_PORT}
      - "--grpc-port"
      - ${PIPELINEGATEWAY_GRPC_PORT}
      - "--metrics-port"
      - ${PIPELINEGATEWAY_METRICS_PORT}

  kafka:
    network_mode: "host"        
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=127.0.0.1:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
    depends_on:
      - zookeeper
      
  zookeeper:
    ports:
      - "2181:2181"
