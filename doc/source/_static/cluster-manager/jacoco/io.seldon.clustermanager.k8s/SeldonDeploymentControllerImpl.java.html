<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SeldonDeploymentControllerImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">seldon-cluster-manager</a> &gt; <a href="index.source.html" class="el_package">io.seldon.clustermanager.k8s</a> &gt; <span class="el_source">SeldonDeploymentControllerImpl.java</span></div><h1>SeldonDeploymentControllerImpl.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright 2017 Seldon Technologies Ltd (http://www.seldon.io/)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *******************************************************************************/
package io.seldon.clustermanager.k8s;

import java.io.IOException;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.google.common.cache.Cache;
import com.google.common.cache.CacheBuilder;

import io.kubernetes.client.ApiClient;
import io.kubernetes.client.ApiException;
import io.kubernetes.client.ProtoClient;
import io.kubernetes.client.ProtoClient.ObjectOrStatus;
import io.kubernetes.client.apis.CoreV1Api;
import io.kubernetes.client.models.ExtensionsV1beta1Deployment;
import io.kubernetes.client.models.ExtensionsV1beta1DeploymentList;
import io.kubernetes.client.models.V1DeleteOptions;
import io.kubernetes.client.models.V1Service;
import io.kubernetes.client.models.V1ServiceList;
import io.kubernetes.client.models.V1Status;
import io.kubernetes.client.proto.Meta.DeleteOptions;
import io.kubernetes.client.proto.V1.Service;
import io.kubernetes.client.proto.V1beta1Extensions.Deployment;
import io.seldon.clustermanager.k8s.SeldonDeploymentOperatorImpl.DeploymentResources;
import io.seldon.clustermanager.k8s.client.K8sClientProvider;
import io.seldon.clustermanager.pb.ProtoBufUtils;
import io.seldon.protos.DeploymentProtos.SeldonDeployment;

@Component
public class SeldonDeploymentControllerImpl implements SeldonDeploymentController {

<span class="fc" id="L53">	private final static Logger logger = LoggerFactory.getLogger(SeldonDeploymentControllerImpl.class);</span>
	private final SeldonDeploymentOperator operator;
	private final K8sClientProvider clientProvider;
	private final KubeCRDHandler crdHandler;
	private final SeldonDeploymentCache mlCache;
<span class="fc" id="L58">	private final SeldonNameCreator seldonNameCreator = new SeldonNameCreator();</span>
	
	private static final String DEPLOYMENT_API_VERSION = &quot;extensions/v1beta1&quot;;
	
<span class="fc" id="L62">	Cache&lt;String, Boolean&gt; deletedCache = CacheBuilder.newBuilder()</span>
<span class="fc" id="L63">		    .maximumSize(1000)</span>
<span class="fc" id="L64">		    .build();</span>

	
	@Autowired
	public SeldonDeploymentControllerImpl(SeldonDeploymentOperator operator, K8sClientProvider clientProvider,KubeCRDHandler crdHandler,SeldonDeploymentCache mlCache) {
<span class="fc" id="L69">		super();</span>
<span class="fc" id="L70">		this.operator = operator;</span>
<span class="fc" id="L71">		this.clientProvider = clientProvider;</span>
<span class="fc" id="L72">		this.crdHandler = crdHandler;</span>
<span class="fc" id="L73">		this.mlCache = mlCache;</span>
<span class="fc" id="L74">	}</span>
	
	private void createDeployments(ProtoClient client,String namespace,List&lt;Deployment&gt; deployments) throws ApiException, IOException, SeldonDeploymentException
	{
<span class="fc bfc" id="L78" title="All 2 branches covered.">		for(Deployment d : deployments)</span>
		{
<span class="fc" id="L80">            final String listApiPath = &quot;/apis/&quot;+DEPLOYMENT_API_VERSION+&quot;/namespaces/{namespace}/deployments/{name}&quot;</span>
<span class="fc" id="L81">                    .replaceAll(&quot;\\{&quot; + &quot;name&quot; + &quot;\\}&quot;, client.getApiClient().escapeString(d.getMetadata().getName()))</span>
<span class="fc" id="L82">                    .replaceAll(&quot;\\{&quot; + &quot;namespace&quot; + &quot;\\}&quot;, client.getApiClient().escapeString(namespace));</span>
<span class="fc" id="L83">            logger.debug(&quot;Will try to call LIST &quot;+listApiPath);</span>
<span class="fc" id="L84">            ObjectOrStatus&lt;Deployment&gt; os = client.list(Deployment.newBuilder(),listApiPath);       </span>
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">            if (os.status != null) {</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">                if (os.status.getCode() == 404) { //Create</span>
<span class="fc" id="L87">                    logger.debug(&quot;About to CREATE &quot;+ProtoBufUtils.toJson(d));</span>
<span class="fc" id="L88">                    final String createApiPath = &quot;/apis/&quot;+DEPLOYMENT_API_VERSION+&quot;/namespaces/{namespace}/deployments&quot;</span>
<span class="fc" id="L89">                            .replaceAll(&quot;\\{&quot; + &quot;namespace&quot; + &quot;\\}&quot;, client.getApiClient().escapeString(namespace));</span>

<span class="fc" id="L91">                    os = client.create(d, createApiPath, DEPLOYMENT_API_VERSION, &quot;Deployment&quot;);</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">                    if (os.status != null) {</span>
<span class="nc" id="L93">                        logger.error(&quot;Error creating deployment:&quot;+ProtoBufUtils.toJson(os.status));</span>
<span class="nc" id="L94">                        throw new SeldonDeploymentException(&quot;Failed to create deployment &quot;+d.getMetadata().getName());</span>
                    }
                    else {
<span class="fc" id="L97">                        logger.debug(&quot;Created deployment:&quot;+ProtoBufUtils.toJson(os.object));</span>
                    }
<span class="fc" id="L99">                }</span>
                else {
<span class="nc" id="L101">                    logger.error(&quot;Error listing deployment:&quot;+ProtoBufUtils.toJson(os.status));</span>
<span class="nc" id="L102">                    throw new SeldonDeploymentException(&quot;Failed to list deployment &quot;+d.getMetadata().getName());</span>
                }
            }
            else { // Update
<span class="nc" id="L106">                logger.debug(&quot;About to UPDATE &quot;+ProtoBufUtils.toJson(d));</span>
<span class="nc" id="L107">                os = client.update(d,listApiPath, DEPLOYMENT_API_VERSION, &quot;Deployment&quot;);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                if (os.status != null) {</span>
<span class="nc" id="L109">                    logger.error(&quot;Error updating deployment:&quot;+ProtoBufUtils.toJson(os.status));</span>
<span class="nc" id="L110">                    throw new SeldonDeploymentException(&quot;Failed to update deployment &quot;+d.getMetadata().getName());</span>
                }
                else {
<span class="nc" id="L113">                    logger.debug(&quot;Updated deployment:&quot;+ProtoBufUtils.toJson(os.object));</span>
                }
            }
<span class="fc" id="L116">		}</span>
<span class="fc" id="L117">	}</span>

	private Set&lt;String&gt; getDeploymentNames(List&lt;Deployment&gt; deployments)
	{
<span class="nc" id="L121">		Set&lt;String&gt; names = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">	    for(Deployment d : deployments)</span>
<span class="nc" id="L123">	        names.add(d.getMetadata().getName());</span>
<span class="nc" id="L124">	    return names;</span>
	}
	
	private int removeDeployments(ProtoClient client,String namespace,SeldonDeployment seldonDeployment,List&lt;Deployment&gt; deployments,boolean svcOrchOnly) throws ApiException, IOException, SeldonDeploymentException
	{
<span class="nc" id="L129">		int deleteCount = 0;</span>
<span class="nc" id="L130">	    Set&lt;String&gt; names = getDeploymentNames(deployments);</span>
<span class="nc" id="L131">	    ExtensionsV1beta1DeploymentList depList = crdHandler.getOwnedDeployments(seldonNameCreator.getSeldonId(seldonDeployment),namespace);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">	    for (ExtensionsV1beta1Deployment d : depList.getItems())</span>
	    {
<span class="nc bnc" id="L134" title="All 4 branches missed.">	    	boolean okToDelete = !svcOrchOnly || (d.getMetadata().getLabels().containsKey(Constants.LABEL_SELDON_SVCORCH));</span>
<span class="nc bnc" id="L135" title="All 4 branches missed.">	        if (okToDelete &amp;&amp; !names.contains(d.getMetadata().getName()))</span>
	        {
<span class="nc" id="L137">	        	deleteCount++;</span>
<span class="nc" id="L138">	            final String deleteApiPath = &quot;/apis/&quot;+DEPLOYMENT_API_VERSION+&quot;/namespaces/{namespace}/deployments/{name}&quot;</span>
<span class="nc" id="L139">	                    .replaceAll(&quot;\\{&quot; + &quot;name&quot; + &quot;\\}&quot;, client.getApiClient().escapeString(d.getMetadata().getName()))</span>
<span class="nc" id="L140">	                    .replaceAll(&quot;\\{&quot; + &quot;namespace&quot; + &quot;\\}&quot;, client.getApiClient().escapeString(namespace));</span>
<span class="nc" id="L141">	            DeleteOptions options = DeleteOptions.newBuilder().setPropagationPolicy(&quot;Foreground&quot;).build();</span>
<span class="nc" id="L142">	            ObjectOrStatus&lt;Deployment&gt; os = client.delete(Deployment.newBuilder(),deleteApiPath,options);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">	            if (os.status != null) {</span>
<span class="nc" id="L144">                    logger.error(&quot;Error deleting deployment:&quot;+ProtoBufUtils.toJson(os.status));</span>
                    //throw new SeldonDeploymentException(&quot;Failed to delete deployment &quot;+d.getMetadata().getName());
                }
                else {
<span class="nc" id="L148">                    logger.debug(&quot;Deleted deployment:&quot;+ProtoBufUtils.toJson(os.object));</span>
                }
<span class="nc" id="L150">	        }</span>
	        else
<span class="nc" id="L152">	        	logger.info(&quot;Skipping deletion of {} svcOrchOnly:{}&quot;,d.getMetadata().getName(),svcOrchOnly);</span>
<span class="nc" id="L153">	    }</span>
<span class="nc" id="L154">	    return deleteCount;</span>
	}
	
	private void removeServices(ApiClient client,String namespace,SeldonDeployment seldonDeployment,List&lt;Service&gt; services) throws ApiException, IOException, SeldonDeploymentException
	{
<span class="nc" id="L159">		Set&lt;String&gt; names = getServiceNames(services);</span>
<span class="nc" id="L160">		V1ServiceList svcList = crdHandler.getOwnedServices(seldonNameCreator.getSeldonId(seldonDeployment),namespace);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">		for(V1Service s : svcList.getItems())</span>
		{
<span class="nc bnc" id="L163" title="All 2 branches missed.">			if (!names.contains(s.getMetadata().getName()))</span>
			{	
<span class="nc" id="L165">				CoreV1Api api = new CoreV1Api(client);</span>
<span class="nc" id="L166">				io.kubernetes.client.models.V1DeleteOptions options = new V1DeleteOptions();</span>
<span class="nc" id="L167">				V1Status status = api.deleteNamespacedService(s.getMetadata().getName(), namespace, options, null, null, null, null);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">				if (!&quot;Success&quot;.equals(status.getStatus()))</span>
				{
<span class="nc" id="L170">					logger.error(&quot;Failed to delete service &quot;+s.getMetadata().getName());</span>
<span class="nc" id="L171">					throw new SeldonDeploymentException(&quot;Failed to delete service &quot;+s.getMetadata().getName());</span>
				}
				else
<span class="nc" id="L174">					logger.debug(&quot;Deleted service &quot;+s.getMetadata().getName());</span>
				
			}
<span class="nc" id="L177">		}</span>
<span class="nc" id="L178">	}</span>
	
	private Set&lt;String&gt; getServiceNames(List&lt;Service&gt; services)
	{
<span class="nc" id="L182">		Set&lt;String&gt; names = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">		for(Service s : services)</span>
<span class="nc" id="L184">			names.add(s.getMetadata().getName());</span>
<span class="nc" id="L185">		return names;</span>
	}
	
	private void createServices(ProtoClient client,String namespace,List&lt;Service&gt; services) throws ApiException, IOException, SeldonDeploymentException
	{
<span class="fc bfc" id="L190" title="All 2 branches covered.">		for(Service service : services)</span>
		{
<span class="fc" id="L192">		    final String serviceApiPath = &quot;/api/v1/namespaces/{namespace}/services/{name}&quot;</span>
<span class="fc" id="L193">	                .replaceAll(&quot;\\{&quot; + &quot;name&quot; + &quot;\\}&quot;, client.getApiClient().escapeString(service.getMetadata().getName()))</span>
<span class="fc" id="L194">	                .replaceAll(&quot;\\{&quot; + &quot;namespace&quot; + &quot;\\}&quot;, client.getApiClient().escapeString(namespace));</span>
<span class="fc" id="L195">	        ObjectOrStatus os = client.list(Service.newBuilder(),serviceApiPath);     </span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">	        if (os.status != null)</span>
	        {
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">	            if (os.status.getCode() == 404)</span>
	            {
<span class="fc" id="L200">	                String serviceCreateApiPath = &quot;/api/v1/namespaces/{namespace}/services&quot;</span>
<span class="fc" id="L201">	                        .replaceAll(&quot;\\{&quot; + &quot;namespace&quot; + &quot;\\}&quot;, client.getApiClient().escapeString(namespace));</span>
<span class="fc" id="L202">	                os = client.create(service, serviceCreateApiPath, &quot;v1&quot;, &quot;Service&quot;);</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">	                if (os.status != null)</span>
	                {
<span class="nc" id="L205">	                    logger.error(&quot;Error creating service &quot;+ProtoBufUtils.toJson(os.status));</span>
<span class="nc" id="L206">	                    throw new SeldonDeploymentException(&quot;Failed to create service &quot;+service.getMetadata().getName());</span>
	                }
	                else
	                {
<span class="fc" id="L210">	                    logger.debug(&quot;Created service:&quot;+ProtoBufUtils.toJson(os.object));</span>
	                }                   
<span class="fc" id="L212">	            }</span>
	            else
	            {
<span class="nc" id="L215">	                logger.error(&quot;Error listing service:&quot;+ProtoBufUtils.toJson(os.status));</span>
<span class="nc" id="L216">	                throw new SeldonDeploymentException(&quot;Failed to list service &quot;+service.getMetadata().getName());</span>
	            }
	        }
	        else
<span class="nc" id="L220">	            logger.debug(&quot;No creating service as already exists &quot;+service.getMetadata().getName());</span>
<span class="fc" id="L221">		}</span>
<span class="fc" id="L222">	}</span>
	
	private void failDeployment(SeldonDeployment mlDep,Exception e)
	{
<span class="fc" id="L226">        SeldonDeployment.Builder mlBuilder = SeldonDeployment.newBuilder(mlDep);</span>
<span class="fc" id="L227">        mlBuilder.getStatusBuilder().setState(Constants.STATE_FAILED).setDescription(e.getMessage());</span>
<span class="fc" id="L228">        crdHandler.updateSeldonDeploymentStatus(mlBuilder.build());</span>
<span class="fc" id="L229">	}</span>
	
	@Override
	public void removeInitialUnusedResources(SeldonDeployment mlDep) {
<span class="nc" id="L233">		logger.info(&quot;Removing initial unused Deployments for Seldon Deployment {}&quot;,mlDep.getSpec().getName());</span>
		try
		{
<span class="nc" id="L236">			SeldonDeployment mlDep2 = operator.defaulting(mlDep);</span>
<span class="nc" id="L237">			DeploymentResources resources = operator.createResources(mlDep2);</span>
<span class="nc" id="L238">			ProtoClient client = clientProvider.getProtoClient();</span>
<span class="nc" id="L239">			String namespace = SeldonDeploymentUtils.getNamespace(mlDep2);</span>
<span class="nc" id="L240">			final String deploymentDeleteKey = mlDep.getMetadata().getUid()+&quot;:&quot;+mlDep.getMetadata().getResourceVersion();</span>
<span class="nc" id="L241">			logger.info(&quot;Deployment delete cache key {}&quot;,deploymentDeleteKey);</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">			if (deletedCache.getIfPresent(deploymentDeleteKey) == null)</span>
			{
<span class="nc" id="L244">				int deleteCount = removeDeployments(client, namespace, mlDep2, resources.deployments,true);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">				if (deleteCount == 0)</span>
				{
<span class="nc" id="L247">					logger.info(&quot;Failed to delete anything from first stage delete so will delete all unsed deployments for {}&quot;,mlDep.getSpec().getName());</span>
<span class="nc" id="L248">					removeDeployments(client, namespace, mlDep2, resources.deployments,false);</span>
				}
<span class="nc" id="L250">				deletedCache.put(deploymentDeleteKey, true);</span>
<span class="nc" id="L251">			}</span>
			else
<span class="nc" id="L253">				logger.info(&quot;Skipping initial delete for {}&quot;,mlDep.getSpec().getName());</span>
<span class="nc" id="L254">		} catch (SeldonDeploymentException e) {</span>
<span class="nc" id="L255">			logger.error(&quot;Failed to cleanup deployment &quot;,e);</span>
<span class="nc" id="L256">		} catch (ApiException e) {</span>
<span class="nc" id="L257">			logger.error(&quot;Kubernetes API exception cleaning up code:&quot;+e.getCode()+ &quot;message:&quot;+e.getResponseBody(),e);</span>
<span class="nc" id="L258">		} catch (IOException e) {</span>
<span class="nc" id="L259">			logger.error(&quot;IOException during cleanup &quot;,e);</span>
<span class="nc" id="L260">		}</span>
<span class="nc" id="L261">	}</span>

	@Override
	public void removeAllUnusedResources(SeldonDeployment mlDep) {
<span class="nc" id="L265">		logger.info(&quot;Removing ALL UNUSED RESOURCES for Seldon Deployment {}&quot;,mlDep.getSpec().getName());</span>
		try
		{
<span class="nc" id="L268">			SeldonDeployment mlDep2 = operator.defaulting(mlDep);</span>
<span class="nc" id="L269">			DeploymentResources resources = operator.createResources(mlDep2);</span>
<span class="nc" id="L270">			ProtoClient client = clientProvider.getProtoClient();</span>
<span class="nc" id="L271">			String namespace = SeldonDeploymentUtils.getNamespace(mlDep2);</span>
<span class="nc" id="L272">			removeDeployments(client, namespace, mlDep2, resources.deployments,false);</span>
<span class="nc" id="L273">			ApiClient client2 = clientProvider.getClient();</span>
<span class="nc" id="L274">			removeServices(client2,namespace, mlDep2, resources.services);</span>
<span class="nc" id="L275">		} catch (SeldonDeploymentException e) {</span>
<span class="nc" id="L276">			logger.error(&quot;Failed to cleanup deployment &quot;,e);</span>
<span class="nc" id="L277">		} catch (ApiException e) {</span>
<span class="nc" id="L278">			logger.error(&quot;Kubernetes API exception cleaning up code:&quot;+e.getCode()+ &quot;message:&quot;+e.getResponseBody(),e);</span>
<span class="nc" id="L279">		} catch (IOException e) {</span>
<span class="nc" id="L280">			logger.error(&quot;IOException during cleanup &quot;,e);</span>
<span class="nc" id="L281">		}</span>
<span class="nc" id="L282">	}</span>

	
	@Override
	public void createOrReplaceSeldonDeployment(SeldonDeployment mlDep,boolean added) {

<span class="pc bpc" id="L288" title="5 of 6 branches missed.">	    if (mlDep.hasStatus() &amp;&amp; mlDep.getStatus().hasState() &amp;&amp; mlDep.getStatus().getState().equals(Constants.STATE_FAILED))</span>
	    {
<span class="nc" id="L290">	        logger.warn(&quot;Ignoring failed deployment &quot;+mlDep.getMetadata().getName());</span>
<span class="nc" id="L291">	        return;</span>
	    }
		try
		{
<span class="fc" id="L295">	        String namespace = SeldonDeploymentUtils.getNamespace(mlDep);</span>
<span class="fc" id="L296">		    SeldonDeployment existing = mlCache.get(mlDep);</span>
<span class="pc bpc" id="L297" title="5 of 6 branches missed.">		    if (added || existing == null || !existing.getSpec().equals(mlDep.getSpec()))</span>
		    {
<span class="fc" id="L299">		        logger.debug(&quot;Running updates for &quot;+mlDep.getMetadata().getName());</span>
<span class="fc" id="L300">		        mlCache.put(mlDep);</span>
<span class="fc" id="L301">		        SeldonDeployment mlDepStatusUpdated = operator.updateStatus(mlDep);</span>
<span class="fc" id="L302">		        SeldonDeployment mlDep2 = operator.defaulting(mlDep);</span>
<span class="fc" id="L303">		        operator.validate(mlDep2);</span>
<span class="fc" id="L304">		        DeploymentResources resources = operator.createResources(mlDep2);</span>
<span class="fc" id="L305">		        ProtoClient client = clientProvider.getProtoClient();</span>
<span class="fc" id="L306">		        createDeployments(client, namespace, resources.deployments);</span>
		        //removeDeployments(client, namespace, mlDep2, resources.deployments);
<span class="fc" id="L308">		        createServices(client, namespace, resources.services);</span>
		        //removeServices(client,namespace, mlDep2, resources.services); //Proto Client not presently working for deletion
		        //ApiClient client2 = clientProvider.getClient();
		        //removeServices(client2,namespace, mlDep2, resources.services);
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">		        if (!mlDep.hasStatus())</span>
		        {
<span class="fc" id="L314">		           logger.debug(&quot;Pushing updated SeldonDeployment &quot;+mlDepStatusUpdated.getMetadata().getName()+&quot; back to kubectl&quot;);</span>
<span class="fc" id="L315">		           crdHandler.updateSeldonDeploymentStatus(mlDepStatusUpdated);</span>
		        }
		        else
<span class="nc" id="L318">		            logger.debug(&quot;Not pushing an update as no change to status for SeldonDeployment &quot;+mlDep2.getMetadata().getName());</span>
<span class="fc" id="L319">		    }</span>
		    else
		    {
<span class="nc" id="L322">		        mlCache.put(mlDep);</span>
<span class="nc" id="L323">		        logger.debug(&quot;Only updated cache for &quot;+mlDep.getMetadata().getName());</span>
		    }
			
<span class="fc" id="L326">		} catch (SeldonDeploymentException e) {</span>
<span class="fc" id="L327">			logger.error(&quot;Failed to create deployment &quot;,e);</span>
<span class="fc" id="L328">			failDeployment(mlDep,e);</span>
<span class="nc" id="L329">		} catch (ApiException e) {</span>
<span class="nc" id="L330">			logger.error(&quot;Kubernetes API exception deploying code:&quot;+e.getCode()+ &quot;message:&quot;+e.getResponseBody(),e);</span>
<span class="nc" id="L331">			failDeployment(mlDep,e);</span>
<span class="nc" id="L332">		} catch (IOException e) {</span>
<span class="nc" id="L333">			logger.error(&quot;IOException during createReplace &quot;,e);</span>
<span class="nc" id="L334">			failDeployment(mlDep,e);</span>
<span class="pc" id="L335">		}</span>
<span class="fc" id="L336">	}</span>

	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>