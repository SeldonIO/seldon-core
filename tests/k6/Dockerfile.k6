ARG K6_VERSION=0.51.0

FROM ubuntu:22.04 AS glibc-donor
ARG TARGETARCH=amd64

RUN arch=${TARGETARCH:-amd64} \
    && case $arch in \
        amd64) rarch=x86_64 ;; \
        arm64) rarch=aarch64 ;; \
    esac \
    && ln -s "${rarch}-linux-gnu" /lib/linux-gnu \
    && case $arch in \
        amd64) ln /lib/linux-gnu/ld-linux-x86-64.so.2 /lib/linux-gnu/ld-2.35.so ;; \
        arm64) ln /lib/linux-gnu/ld-linux-aarch64.so.1 /lib/linux-gnu/ld-2.35.so ;; \
    esac

FROM alpine:3.19.1 AS builder

RUN apk add --update \
 python3 \
 curl \
 which \
 bash

RUN curl -sSL https://sdk.cloud.google.com | bash

FROM clickhouse/clickhouse-server:24.11.1-alpine AS clickhouse

FROM grafana/k6:${K6_VERSION}
ARG K6_VERSION
USER root

RUN apk add --update python3 uuidgen sed go

COPY --from=builder /root/google-cloud-sdk /root/google-cloud-sdk
COPY --from=glibc-donor /lib/linux-gnu/libc.so.6 /lib/linux-gnu/libdl.so.2 /lib/linux-gnu/libm.so.6 /lib/linux-gnu/libpthread.so.0 /lib/linux-gnu/librt.so.1 /lib/linux-gnu/libnss_dns.so.2 /lib/linux-gnu/libnss_files.so.2 /lib/linux-gnu/libresolv.so.2 /lib/linux-gnu/ld-2.35.so /lib/
COPY --from=glibc-donor /etc/nsswitch.conf /etc/
ARG TARGETARCH
RUN arch=${TARGETARCH:-amd64} \
    && case $arch in \
        amd64) mkdir -p /lib64 && ln -sf /lib/ld-2.35.so /lib64/ld-linux-x86-64.so.2 ;; \
        arm64) ln -sf /lib/ld-2.35.so /lib/ld-linux-aarch64.so.1 ;; \
    esac

COPY --from=clickhouse /etc/clickhouse-client /etc/clickhouse-client/
COPY --from=clickhouse /usr/bin/clickhouse /usr/bin/clickhouse
RUN ln -s /usr/bin/clickhouse /usr/bin/clickhouse-client

ENV PATH $PATH:/root/google-cloud-sdk/bin

RUN mkdir k6
RUN mkdir /home/apis

# k6.tar.gz is created by make to get around .dockerignore
ADD k6.tar.gz k6/
# copy protos
ADD apis /home/apis/

WORKDIR k6

RUN go install go.k6.io/xk6/cmd/xk6@latest
RUN ~/go/bin/xk6 build v${K6_VERSION} --with github.com/grafana/xk6-kubernetes --with github.com/Maksimall89/xk6-output-clickhouse@latest

RUN mkdir results

RUN chmod +x k6wrapper.sh
ENTRYPOINT ["./k6wrapper.sh", "run"]

ARG GIT_COMMIT=${GIT_COMMIT}
ARG GIT_BRANCH=${GIT_COMMIT}
ENV GIT_COMMIT=${GIT_COMMIT}
ENV GIT_BRANCH=${GIT_BRANCH}

# should be overriden in practice
CMD ["-u", "5", "scenarios/infer_constant_vu.js"]
